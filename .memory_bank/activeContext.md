# Активный Контекст

**Дата последнего обновления**: 2025-12-27

## Текущий Фокус

**Medieval Hexagon Map Editor** — это отдельный независимый проект для создания и редактирования гексагональных карт. Проект полностью независим и не связан с другими игровыми проектами.

**Текущая задача**: ✅ **ЗАВЕРШЕНО** - Исправление множественного выделения (рамка у всех выделенных тайлов) и undo/redo операций.

**Система уровней**: Редактор поддерживает до 5 уровней высоты (0-4). Каждый уровень имеет фиксированную высоту (LEVEL_HEIGHT), равную высоте базового тайла. Тайлы верхних уровней размещаются на верхней поверхности нижележащих уровней.

## Активные Задачи

- [x] Настроить Next.js 16 + React 19 проект
- [x] Установить и настроить Shadcn/ui компоненты
- [x] Создать TypeScript версии Map и Hex классов
- [x] Создать React компонент MapEditor с Three.js интеграцией
- [x] Адаптировать ModelLoader для Next.js
- [x] Создать UI компоненты редактора (панели, кнопки)
- [x] Настроить пути к assets (симлинк)
- [x] Настроить Biome для линтинга
- [x] Настроить Bun как пакетный менеджер
- [x] Изучить и применить правила livedocs
- [x] Исправить позиционирование тайлов по уровням высоты
- [x] Упростить логику выделения тайлов (всегда выбирается верхний тайл)
- [x] Реализовать систему сохранения/загрузки карт
- [x] Исправить загрузку текстур в превью тайлов
- [x] Провести анализ системы координат для LLM-генерации карт
- [x] Реализовать полный переход на осевые координаты (q, r)
- [x] Реализовать копирование и вставку тайлов (Ctrl+C, Ctrl+V)
- [x] Реализовать множественное выделение (Ctrl+ЛКМ)
- [x] Реализовать undo/redo для операций копирования/вставки (Ctrl+Z, Ctrl+Y, Ctrl+Shift+Z)
- [x] Исправить визуализацию множественного выделения (рамка у всех выделенных тайлов)
- [x] Исправить логику undo/redo (сохранение истории до и после операций)

## Контекст Сессии

### Недавние изменения

1. **✅ Исправлено позиционирование тайлов по уровням высоты**:
   - Введена константа `LEVEL_HEIGHT` (высота базового тайла) вместо использования переменной `actualHeight`
   - Тайлы верхних уровней теперь правильно размещаются на верхней поверхности нижележащих уровней
   - Формула позиционирования: `Y = level * LEVEL_HEIGHT - minY`
   - LEVEL_HEIGHT устанавливается один раз при первой загрузке базового тайла и используется как константа

2. **✅ Упрощена логика выделения тайлов**:
   - Убран параметр `height` из типа `selectedHex`
   - При клике всегда выбирается самый верхний тайл (topmost) независимо от `currentHeightLevel`
   - Упрощена функция `handleCanvasClick` - всегда возвращает верхний тайл из результатов raycaster
   - Обновлены все связанные функции для работы с topmost hex

3. **✅ Создана структура Memory Bank**: Инициализированы все необходимые файлы документации согласно методологии livedocs

4. **✅ Реализована система сохранения/загрузки карт**:
   - Создан `MapSerializer` класс для сериализации/десериализации карт
   - Оптимизированный JSON формат с sparse array (только непустые позиции)
   - Поддержка многоуровневых гексов (стеков до 5 уровней)
   - Сохранение метаданных моделей (obj, mtl, name)
   - Версионирование формата для совместимости
   - Интеграция кнопок Save/Open в UI редактора
   - Документация формата в `docs/map-file-format.md`
   - **Улучшения UX**: Диалог для имени карты при сохранении, toast уведомления вместо alert
   - **Валидация**: Проверка формата файла перед загрузкой через `MapSerializer.validate()`
   - **Тестирование**: Созданы unit-тесты для MapSerializer (21 тест, все проходят)

5. **✅ Исправлена загрузка текстур в превью тайлов**:
   - Реализована очередь последовательного рендеринга превью для избежания конфликтов
   - Добавлена функция `waitForTexturesLoaded()` для проверки загрузки всех текстур в модели
   - Каждое превью использует уникальный идентификатор для корректной работы с общей сценой
   - Исправлены искажения пропорций при копировании изображения на 2D канвас
   - Добавлена правильная проверка загрузки HTMLImageElement через `complete` и `naturalWidth`
   - Реализовано ожидание загрузки текстур с таймаутом и дополнительными кадрами для применения в GPU

6. **✅ Проведен анализ системы координат для LLM-генерации**:
   - Создан документ `docs/hex-coordinates-analysis.md` с детальным сравнением
   - Выявлены проблемы: неправильная формула расстояния (используется Manhattan для квадратной сетки)
   - **Принято решение**: Полный переход на осевые координаты `(q, r)` вместо гибридного подхода
   - Обновлен план внедрения на 7 фаз полного рефакторинга
   - **Ключевые решения**:
     - Вся внутренняя логика переходит на осевые координаты `(q, r)`
     - Все классы (`Hex`, `Map`) используют `q, r` вместо `x, y`
     - Сериализация использует осевые координаты по умолчанию (версия формата 2.0)
     - Формула расстояния: `distance(a, b) = (|a.q - b.q| + |a.q + a.r - b.q - b.r| + |a.r - b.r|) / 2`
     - Упрощённая логика соседей: единообразное вычисление без условных операторов

7. **✅ Реализовано копирование и вставка тайлов**:
   - Копирование верхнего тайла в ячейке (Ctrl+C)
   - Вставка тайла в ячейку под курсором мыши (Ctrl+V)
   - Сохранение относительной высоты при вставке
   - Поддержка множественного копирования/вставки

8. **✅ Реализовано множественное выделение**:
   - Выделение нескольких тайлов (Ctrl+ЛКМ)
   - Визуализация рамки у всех выделенных тайлов
   - Массовое копирование/вставка выделенных тайлов

9. **✅ Реализована система undo/redo**:
   - История изменений до 50 состояний
   - Отмена операций (Ctrl+Z)
   - Повтор операций (Ctrl+Y, Ctrl+Shift+Z)
   - Сохранение состояния до и после операций редактирования
   - Флаг isUndoRedoInProgressRef для предотвращения сохранения истории во время undo/redo

### Открытые вопросы

Все вопросы решены.

### Принятые решения

1. **Memory Bank в корне проекта**: Используем `.memory_bank/` в корне для единой документации проекта
2. **Независимый проект**: **Medieval Hexagon Map Editor** - полностью независимый проект на Next.js 16 + React 19
3. **TypeScript**: Все классы (`Map`, `Hex`, `MapSerializer`) реализованы на TypeScript в `lib/game/`
4. **Bun**: Используем Bun как пакетный менеджер (быстрее npm)
5. **Biome**: Линтер и форматер (быстрее ESLint+Prettier)
6. **Turbopack**: Bundler по умолчанию (быстрее webpack для dev)
7. **Shadcn/ui тема**: Maia style, Cyan theme, Large radius, Public Sans font, темная тема по умолчанию
8. **Система уровней тайлов**: LEVEL_HEIGHT - константа, равная высоте базового тайла. Используется для позиционирования всех уровней
9. **Выделение тайлов**: Всегда выбирается верхний тайл в стопке. Поддержка множественного выделения с визуализацией рамки у всех выделенных тайлов
10. **Формат файла карты**: JSON формат с оптимизацией (sparse array, минимизация повторяющихся данных). Размер файла: ~200 байт на гекс. Поддержка версионирования для совместимости (версия 2.0 с осевыми координатами)
11. **Тестирование**: Vitest настроен для unit-тестов. MapSerializer и HexCoordinateConverter покрыты тестами
12. **UX улучшения**: Toast уведомления для обратной связи, диалог для имени карты, валидация файлов перед загрузкой
13. **Осевые координаты**: Использование (q, r) координат для LLM-совместимости
14. **Undo/Redo**: История изменений до 50 состояний с поддержкой Ctrl+Z/Ctrl+Y

## Важные Заметки

- **Правила livedocs**: Отныне перед началом каждой задачи нужно читать `activeContext.md` для понимания контекста
- **Обновление документации**: После каждого значимого изменения обновлять соответствующие файлы Memory Bank
- **Git хэш**: В `progress.md` должен быть актуальный хэш последнего коммита для отслеживания изменений
- **Независимый проект**: Medieval Hexagon Map Editor - полностью отдельный проект, не связанный с другими игровыми проектами
