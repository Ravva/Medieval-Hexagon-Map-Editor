# Активный Контекст

**Дата последнего обновления**: 2025-12-27 21:20

## Текущий Фокус

**Полный переход на осевые координаты для LLM-совместимости**: Принято решение о полном переходе с odd-r offset координат `(x, y)` на осевые координаты `(q, r)` для оптимальной совместимости с LLM-генерацией карт.

**Важно**: Редактор карт выделен в отдельный проект **"Medieval Hexagon Map Editor"** (ранее `editor-nextjs`), который полностью независим от основного игрового проекта. Все изменения применяются только к редактору.

**Текущая задача**: ✅ **ЗАВЕРШЕНО** - Полный переход на осевые координаты `(q, r)` успешно реализован. Все 6 фаз выполнены: создан HexCoordinateConverter, обновлены Hex и Map классы, обновлен MapSerializer с миграцией 1.0→2.0, обновлен MapEditor для рендеринга, обновлена документация.

**Система уровней**: Редактор поддерживает до 5 уровней высоты (0-4). Каждый уровень имеет фиксированную высоту (LEVEL_HEIGHT), равную высоте базового тайла. Тайлы верхних уровней размещаются на верхней поверхности нижележащих уровней.

## Активные Задачи

- [x] Настроить Next.js 16 + React 19 проект
- [x] Установить и настроить Shadcn/ui компоненты
- [x] Создать TypeScript версии Map и Hex классов
- [x] Создать React компонент MapEditor с Three.js интеграцией
- [x] Адаптировать ModelLoader для Next.js
- [x] Создать UI компоненты редактора (панели, кнопки)
- [x] Настроить пути к assets из основного проекта (симлинк)
- [x] Настроить Biome для линтинга
- [x] Настроить Bun как пакетный менеджер
- [x] Изучить и применить правила livedocs
- [x] Исправить позиционирование тайлов по уровням высоты
- [x] Упростить логику выделения тайлов (всегда выбирается верхний тайл)
- [x] Реализовать систему сохранения/загрузки карт
- [x] Исправить загрузку текстур в превью тайлов
- [x] Провести анализ системы координат для LLM-генерации карт
- [x] Реализовать полный переход на осевые координаты (q, r)

## Контекст Сессии

### Недавние изменения

1. **✅ Исправлено позиционирование тайлов по уровням высоты**:
   - Введена константа `LEVEL_HEIGHT` (высота базового тайла) вместо использования переменной `actualHeight`
   - Тайлы верхних уровней теперь правильно размещаются на верхней поверхности нижележащих уровней
   - Формула позиционирования: `Y = level * LEVEL_HEIGHT - minY`
   - LEVEL_HEIGHT устанавливается один раз при первой загрузке базового тайла и используется как константа

2. **✅ Упрощена логика выделения тайлов**:
   - Убран параметр `height` из типа `selectedHex`
   - При клике всегда выбирается самый верхний тайл (topmost) независимо от `currentHeightLevel`
   - Упрощена функция `handleCanvasClick` - всегда возвращает верхний тайл из результатов raycaster
   - Обновлены все связанные функции для работы с topmost hex

3. **✅ Создана структура Memory Bank**: Инициализированы все необходимые файлы документации согласно методологии livedocs
4. **✅ Реализована система сохранения/загрузки карт**:
   - Создан `MapSerializer` класс для сериализации/десериализации карт
   - Оптимизированный JSON формат с sparse array (только непустые позиции)
   - Поддержка многоуровневых гексов (стеков до 5 уровней)
   - Сохранение метаданных моделей (obj, mtl, name)
   - Версионирование формата для совместимости
   - Интеграция кнопок Save/Open в UI редактора
   - Документация формата в `docs/map-file-format.md`
   - **Улучшения UX**: Диалог для имени карты при сохранении, toast уведомления вместо alert
   - **Валидация**: Проверка формата файла перед загрузкой через `MapSerializer.validate()`
   - **Тестирование**: Созданы unit-тесты для MapSerializer (21 тест, все проходят)
5. **✅ Завершена миграция редактора карт на Next.js**:
   - Создан React компонент `MapEditor.tsx` с полной интеграцией Three.js
   - Адаптирован `ModelLoader` для Next.js с динамическими импортами
   - Созданы UI компоненты на Shadcn/ui
   - Настроен симлинк для доступа к assets
   - Проект успешно собирается

6. **✅ Исправлена загрузка текстур в превью тайлов**:
   - Реализована очередь последовательного рендеринга превью для избежания конфликтов
   - Добавлена функция `waitForTexturesLoaded()` для проверки загрузки всех текстур в модели
   - Каждое превью использует уникальный идентификатор для корректной работы с общей сценой
   - Исправлены искажения пропорций при копировании изображения на 2D канвас
   - Добавлена правильная проверка загрузки HTMLImageElement через `complete` и `naturalWidth`
   - Реализовано ожидание загрузки текстур с таймаутом и дополнительными кадрами для применения в GPU

7. **✅ Проведен анализ системы координат для LLM-генерации**:
   - Создан документ `docs/hex-coordinates-analysis.md` с детальным сравнением
   - Выявлены проблемы: неправильная формула расстояния (используется Manhattan для квадратной сетки)
   - **Принято решение**: Полный переход на осевые координаты `(q, r)` вместо гибридного подхода
   - Обновлен план внедрения на 7 фаз полного рефакторинга
   - **Ключевые решения**:
     - Вся внутренняя логика переходит на осевые координаты `(q, r)`
     - Все классы (`Hex`, `Map`) используют `q, r` вместо `x, y`
     - Сериализация использует осевые координаты по умолчанию (версия формата 2.0)
     - Формула расстояния: `distance(a, b) = (|a.q - b.q| + |a.q + a.r - b.q - b.r| + |a.r - b.r|) / 2`
     - Упрощённая логика соседей: единообразное вычисление без условных операторов

### Открытые вопросы

Все вопросы решены:
- ✅ ModelLoader адаптирован с динамическими импортами для Next.js
- ✅ Пути к assets настроены через симлинк `editor-nextjs/public/assets -> ../../assets`

### Принятые решения

1. **Memory Bank в корне проекта**: Используем `.memory_bank/` в корне для единой документации всего проекта
2. **Отдельный проект редактора**: Редактор карт выделен в отдельный проект **"Medieval Hexagon Map Editor"** на Next.js 16 + React 19, полностью независимый от основного игрового проекта (Vanilla JS)
3. **TypeScript для редактора**: Классы редактора (`Map`, `Hex`) реализованы на TypeScript в `Medieval Hexagon Map Editor/lib/game/`
4. **Bun для editor-nextjs**: Используем Bun как более быстрый пакетный менеджер (в 3-4 раза быстрее npm)
5. **Biome для линтинга**: Заменил ESLint+Prettier (в 10-100 раз быстрее)
6. **Turbopack**: Добавлен как bundler по умолчанию (в 10-700 раз быстрее webpack для dev)
7. **Shadcn/ui тема**: Maia style, Cyan theme, Large radius, Public Sans font, темная тема по умолчанию
8. **Система уровней тайлов**: LEVEL_HEIGHT - константа, равная высоте базового тайла. Используется для позиционирования всех уровней
9. **Выделение тайлов**: Всегда выбирается верхний тайл в стопке, упрощена структура данных (без height в selectedHex)
10. **Формат файла карты**: JSON формат с оптимизацией (sparse array, минимизация повторяющихся данных). Размер файла: ~200 байт на гекс. Поддержка версионирования для совместимости
11. **Тестирование**: Vitest настроен для unit-тестов. MapSerializer полностью покрыт тестами (21 тест)
12. **UX улучшения**: Toast уведомления для обратной связи, диалог для имени карты, валидация файлов перед загрузкой

## План Перехода на Осевые Координаты

Детальный план из `docs/hex-coordinates-analysis.md`:

### Фаза 1: Подготовка и Утилиты Конвертации ✅
- [x] Создать `lib/game/HexCoordinateConverter.ts` класс с функциями:
  - [x] `axialToPixel(q, r, hexSize)` - конвертация осевых координат в экранные для рендеринга
  - [x] `pixelToAxial(x, y, hexSize)` - обратная конвертация (для кликов)
  - [x] `offsetToAxial(x, y)` - конвертация из текущего формата (для миграции)
  - [x] `axialToOffset(q, r)` - обратная конвертация (для обратной совместимости)
  - [x] `axialToWorld(q, r, mapWidth, mapHeight, hexSize)` - конвертация для Three.js рендеринга
  - [x] `worldToAxial(worldX, worldZ, ...)` - обратная конвертация для raycasting
  - [x] `axialDistance(a, b)` - расчет расстояния между гексами
  - [x] `getAxialNeighbors(q, r)` - получение соседей (единообразно, без условий)
- [x] Добавить тесты в `lib/game/__tests__/HexCoordinateConverter.test.ts` (26 тестов, все проходят)

### Фаза 2: Рефакторинг Класса Hex ✅
- [x] Изменить `lib/game/Hex.ts`: `x, y` → `q, r`
- [x] Обновить конструктор: `constructor(q: number, r: number, terrain: TerrainType)`
- [x] Реализовать метод `distanceTo(otherHex: Hex): number` с правильной формулой
- [x] Обновить все методы класса для работы с `q, r`

### Фаза 3: Рефакторинг Класса Map ✅
- [x] Изменить `lib/game/Map.ts`: все методы работают с `q, r`
- [x] Обновить `getNeighborCoordinates(q, r)` - убрать условную логику (четность ряда)
- [x] Изменить структуру хранения: `Map<string, Hex[]>` с ключом `"q,r"` вместо массива
- [x] Обновить `isValidCoordinate(q, r)` для осевых координат
- [x] Обновить `getIndex(q, r)` → `getKey(q, r)` для работы с Map
- [x] Обновить все методы: `getHex`, `setHex`, `removeHex`, `getHexStack`, `hasHex`

### Фаза 4: Обновление Сериализации ✅
- [x] Обновить `lib/game/MapSerializer.ts`: формат версии 2.0 с осевыми координатами
- [x] Изменить интерфейс `HexData`: `x, y` → `q, r`
- [x] Изменить интерфейс `BuildingData`: `x, y` → `q, r`
- [x] Изменить ключи в `hexes`: `"q,r"` вместо `"x,y"`
- [x] Добавить поддержку миграции формата 1.0 → 2.0 (конвертация при загрузке)
- [x] Обновить валидацию формата
- [x] Обновить все тесты в `lib/game/__tests__/MapSerializer.test.ts` (22 теста, все проходят)

### Фаза 5: Обновление Рендеринга ✅
- [x] Обновить `components/MapEditor.tsx`: заменить `hexToWorld(x, y)` на `hexToWorld(q, r)` с использованием `HexCoordinateConverter`
- [x] Обновить все места использования координат:
  - [x] Функция `hexToWorld` → использовать `axialToWorld`
  - [x] Все вызовы `hex.x`, `hex.y` → `hex.q`, `hex.r`
  - [x] Все вызовы `map.getHex(x, y)` → `map.getHex(q, r)`
  - [x] Все вызовы `map.setHex(x, y, hex)` → `map.setHex(q, r, hex)`
  - [x] Все ключи в `hexMeshesRef`: `"q,r"` вместо `"x,y"`
  - [x] Обновить логику навигации (WASD) - убрать проверку четности, упростить
- [x] Протестировать визуальное отображение

### Фаза 6: Обновление Документации ✅
- [x] Обновить `docs/map-file-format.md` с новым форматом версии 2.0
- [x] Обновить `docs/hex-coordinates-analysis.md` с информацией о завершении перехода

## Следующие Шаги

1. **Начать с Фазы 1**: Создать `HexCoordinateConverter` с функциями конвертации
2. **Протестировать конвертацию**: Убедиться, что формулы работают корректно
3. **Поэтапно выполнить рефакторинг**: Фазы 2-5 последовательно
4. **Обновить документацию**: После завершения всех фаз

## Важные Заметки

- **Правила livedocs**: Отныне перед началом каждой задачи нужно читать `activeContext.md` для понимания контекста
- **Обновление документации**: После каждого значимого изменения обновлять соответствующие файлы Memory Bank
- **Git хэш**: В `progress.md` должен быть актуальный хэш последнего коммита для отслеживания изменений

