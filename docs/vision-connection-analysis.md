# Vision Анализ Соединений Тайлов

## Обзор

Система визуального анализа соединений тайлов использует локальные vision модели для автоматического определения типов соединений на основе скриншотов 3D моделей тайлов.

## Архитектура

### Компоненты

1. **TileVisionRenderer** (`lib/llm/TileVisionRenderer.ts`)
   - Утилита для рендеринга скриншотов тайла с 6 разных углов
   - Каждый скриншот фокусируется на одном ребре гексагона
   - Возвращает base64-encoded PNG изображения

2. **API Endpoint** (`/api/llm/analyze-connections-vision`)
   - Принимает 6 изображений (по одному на каждое ребро)
   - Отправляет их в локальную vision модель
   - Возвращает типы соединений для каждого ребра

3. **UI Интерфейс** (`/generate-registry`)
   - Кнопка "Использовать Vision анализ"
   - Настройки локального сервера (URL, модель)
   - Автоматическое применение результатов

## Использование

### Требования

1. **Локальный Vision сервер**
   - OpenAI-совместимый API (например, Ollama с vision моделями)
   - Endpoint: `/v1/chat/completions`
   - Поддержка формата с `image_url` в сообщениях

2. **Vision модель**
   - Должна поддерживать анализ изображений
   - Примеры: `llava`, `bakllava`, `moondream`, и т.д.

### Процесс

1. Откройте страницу `/generate-registry`
2. Сгенерируйте реестр тайлов (кнопка "Сгенерировать")
3. Выберите тайл для анализа из списка
4. Нажмите "Использовать Vision анализ"
5. Настройте:
   - URL локального сервера (по умолчанию `http://localhost:1234`)
   - Нажмите "Загрузить" для получения списка моделей
   - Выберите vision модель из списка
6. Нажмите "Анализировать соединения"
7. Система автоматически:
   - Рендерит 6 скриншотов тайла с разных углов
   - Отправляет их в vision модель
   - Применяет результаты к `editedConnections`

## Формат Данных

### Входные данные (API)

```json
{
  "images": ["base64_image_1", "base64_image_2", ...], // 6 изображений
  "localUrl": "http://localhost:1234",
  "model": "llava",
  "tileType": "river" | "road" | "coast" | "base" | "other",
  "biome": "plains" | "water" | "forest" | "mountain"
}
```

### Выходные данные (API)

```json
{
  "success": true,
  "connections": {
    "east": "grass" | "water" | "coast" | "road" | null,
    "southeast": "grass" | "water" | "coast" | "road" | null,
    "southwest": "grass" | "water" | "coast" | "road" | null,
    "west": "grass" | "water" | "coast" | "road" | null,
    "northwest": "grass" | "water" | "coast" | "road" | null,
    "northeast": "grass" | "water" | "coast" | "road" | null
  }
}
```

## Типы Соединений

- **grass**: Зеленая местность, растительность, земля
- **water**: Синяя вода, река, озеро
- **coast**: Переход между землей и водой (песчаный, пляжный)
- **road**: Коричневая/грязная дорога, дорожная поверхность
- **null**: Нет соединения (сплошная стена, закрыто)

## Технические Детали

### Рендеринг Скриншотов

- Разрешение: 512x512 пикселей
- Формат: PNG
- Углы обзора: 6 направлений (0°, 60°, 120°, 180°, 240°, 300°)
- Расстояние камеры: 8 единиц
- Высота камеры: 4.8 единицы (60% от расстояния)

### Промпт для Vision Модели

Система отправляет детальный промпт с описанием:
- Типа тайла и биома
- Порядка изображений (какое изображение соответствует какому ребру)
- Визуальных индикаторов для каждого типа соединения
- Требований к формату ответа (JSON)

### Обработка Ошибок

- Таймаут: 5 минут на запрос
- Валидация: Проверка формата ответа, типов соединений
- Fallback: Если vision модель не обнаружила соединений, пользователь может вручную отредактировать

## Примеры Использования

### Ollama с Llava

```bash
# Запуск Ollama с Llava моделью
ollama serve

# В другом терминале
ollama pull llava
```

Настройки в UI:
- URL: `http://localhost:11434` (или ваш порт Ollama)
- Модель: `llava`

### LM Studio

1. Запустите LM Studio
2. Загрузите vision модель (например, `llava`)
3. Запустите локальный сервер
4. Используйте URL из LM Studio (обычно `http://localhost:1234`)

## Ограничения

1. **Точность**: Зависит от качества vision модели
2. **Производительность**: Рендеринг 6 скриншотов может занять время
3. **Совместимость**: Требуется OpenAI-совместимый API с поддержкой изображений
4. **Размер изображений**: Base64-encoded изображения увеличивают размер запроса

## Будущие Улучшения

- [ ] Кэширование результатов vision анализа
- [ ] Пакетная обработка нескольких тайлов
- [ ] Поддержка других форматов vision API
- [ ] Визуализация скриншотов перед отправкой
- [ ] Настройка параметров рендеринга (разрешение, угол обзора)

